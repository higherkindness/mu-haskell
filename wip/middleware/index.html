<!DOCTYPE html>
<html>
    <head>
    <meta charset="UTF-8">

    

    <title>Mu-Haskell: Middleware</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Mu is a purely functional library for building microservices.">
    <meta name="keywords" content="functional-programming, monads, monad-transformers, functional-data-structure, swift, bow, fp-types, adt, free-monads, tagless-final, mtl, for-comprehension, category-theory">

    <meta property="og:image" content="/mu-haskell/wip/img/poster.png" />
    <meta property="og:title" content="Mu-Haskell: Middleware" />
    <meta property="og:site_name" content="Mu-Haskell: Middleware" />
    <meta property="og:url" content="https://higherkindess.io/mu-haskell" />
    <meta property="og:type" content="website" />
    <meta property="og:description" content="Mu is a purely functional library for building microservices." />
    <meta property="og:keywords" content="functional-programming, monads, monad-transformers, functional-data-structure, swift, bow, fp-types, adt, free-monads, tagless-final, mtl, for-comprehension, category-theory" />

    <meta name="twitter:text:description" content="Mu is a purely functional library for building microservices." />
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:site" content="@47deg">
    <meta name="twitter:creator" content="@47deg">
    <meta name="twitter:image" content="/mu-haskell/wip/img/poster.png" />

    <meta property="github-info" data-github-owner="higherkindness" data-github-repo="mu-haskell" />

    <script defer src="/mu-haskell/wip/js/docs.js"></script>

    <!-- Favicon -->
    <link rel="shortcut icon" href="/mu-haskell/wip/img/favicon.png">

    <!-- mu-haskell docs css -->
    <link rel="stylesheet" type="text/css" href="/mu-haskell/wip/css/docs.css">
</head>

    <body>
        <div id="site-sidebar" class="site-sidebar">
  <div class="sidebar-brand">
    <a href="/mu-haskell/wip/" class="brand" title="Mu-Haskell">
      <img
        src="/mu-haskell/wip/img/nav-brand-white.svg"
        alt="Mu-Haskell"
        class="brand-wrapper"
      />
      <span>Mu-Haskell</span>
    </a>
    <button
      id="main-toggle"
      type="button"
      title="Close"
      class="button sidebar-toggle"
    >
      <span class="close"></span>
    </button>
  </div>
  <div class="sidebar-menu">
    
      

      
      
      
      

      
      
      

      

      

    <div class="sidebar-menu-item  ">
      
      <a
        href="/mu-haskell/wip/"
        class=""
        title="Start"
      >
        Start
      </a>
      
    </div>
    

      
      
      
      

      
      
      

      

      

    <div class="sidebar-menu-item  ">
       
      <button
        type="button"
        title="Open Introduction"
        class="button drop-nested"
      >
        Introduction
      </button>
      <div class="caret"></div>
      

      <div class="sub-menu">
        
        
        
        <a
          class=""
          href="/mu-haskell/wip/intro-rpc/"
          title="For RPC"
        >
          For RPC
        </a>
        
        
        
        <a
          class=""
          href="/mu-haskell/wip/intro-graphql/"
          title="For GraphQL"
        >
          For GraphQL
        </a>
        
      </div>
      
    </div>
    

      
      
      
      

      
      
      

      

      

    <div class="sidebar-menu-item  ">
       
      <a
        href="/mu-haskell/wip/schema/"
        title="Schemas"
        class="drop-nested"
      >
        Schemas
      </a>
      <div class="caret"></div>
      

      <div class="sub-menu">
        
        
        
        <a
          class=""
          href="/mu-haskell/wip/serializers/"
          title="Serialization formats"
        >
          Serialization formats
        </a>
        
        
        
        <a
          class=""
          href="/mu-haskell/wip/registry/"
          title="Registry"
        >
          Registry
        </a>
        
      </div>
      
    </div>
    

      
      
      
      

      
      
      

      

      

    <div class="sidebar-menu-item  ">
       
      <a
        href="/mu-haskell/wip/rpc/"
        title="RPC services"
        class="drop-nested"
      >
        RPC services
      </a>
      <div class="caret"></div>
      

      <div class="sub-menu">
        
        
        
        <a
          class=""
          href="/mu-haskell/wip/grpc/server/"
          title="gRPC servers"
        >
          gRPC servers
        </a>
        
        
        
        <a
          class=""
          href="/mu-haskell/wip/grpc/client/"
          title="gRPC clients"
        >
          gRPC clients
        </a>
        
      </div>
      
    </div>
    

      
      
      
      

      
      
      

      

      

    <div class="sidebar-menu-item  ">
      
      <a
        href="/mu-haskell/wip/graphql/"
        class=""
        title="GraphQL services"
      >
        GraphQL services
      </a>
      
    </div>
    

      
      
      
      

      
      
      

      

      

    <div class="sidebar-menu-item  open">
       
      <button
        type="button"
        title="Open Integrations"
        class="button drop-nested"
      >
        Integrations
      </button>
      <div class="caret"></div>
      

      <div class="sub-menu">
        
        
        
        <a
          class=""
          href="/mu-haskell/wip/db/"
          title="Databases"
        >
          Databases
        </a>
        
        
        
        <a
          class=""
          href="/mu-haskell/wip/transformer/"
          title="Transformers"
        >
          Transformers
        </a>
        
        
        
        <a
          class="active"
          href="/mu-haskell/wip/middleware/"
          title="Middleware"
        >
          Middleware
        </a>
        
      </div>
      
    </div>
    
    
  </div>
</div>

        <main id="site-doc" class="site-doc">
    <div class="doc-header">
      <button
        id="menu-toggle"
        type="button"
        class="button doc-toggle"
        title="Toggle">
          <img src="/mu-haskell/wip/img/sidebar-icon-open.svg" alt="Toggle" title="Toggle">
      </button>

      <div class="link-container">
        
        <div id="version-dropdown" class="link-item">

    <button class="button link-like strong" onclick="openDropdown(event)" title="Version">
      
        <i class="nav-item-icon fa fa-lg " aria-hidden="true"></i>
        <span class="nav-item-text">Version</span>
      
    </button>

    <ul class="dropdown dropdown-content">
      
      <li class="dropdown-item">
        <a class="dropdown-item-link" title="Stable" href="https://higherkindness.io/mu-haskell/" target="_blank" rel="noopener noreferrer">
            <span>
              Stable
            </span>
        </a>
      </li>
      
      <li class="dropdown-item">
        <a class="dropdown-item-link" title="Next" href="https://higherkindness.io/mu-haskell/wip" target="_blank" rel="noopener noreferrer">
            <span>
              Next
            </span>
        </a>
      </li>
      
    </ul>

</div>

        
        <div id="api-docs-dropdown" class="link-item">

    <button class="button link-like strong" onclick="openDropdown(event)" title="API Docs">
      
        <i class="nav-item-icon fa fa-lg " aria-hidden="true"></i>
        <span class="nav-item-text">API Docs</span>
      
    </button>

    <ul class="dropdown dropdown-content">
      
      <li class="dropdown-item">
        <a class="dropdown-item-link" title="Stable" href="https://higherkindness.io/mu-haskell/haddock" target="_blank" rel="noopener noreferrer">
            <span>
              Stable
            </span>
        </a>
      </li>
      
      <li class="dropdown-item">
        <a class="dropdown-item-link" title="Next" href="https://higherkindness.io/mu-haskell/wip/haddock" target="_blank" rel="noopener noreferrer">
            <span>
              Next
            </span>
        </a>
      </li>
      
    </ul>

</div>

        
        <div class="link-item">
          <a href="https://github.com/higherkindness/mu-haskell" title="GitHub repo" target="_blank" rel="noopener noreferrer">
            <span class="strong">GitHub</span>
            <span id="stars-count"></span>
          </a>
        </div>
      </div>

    </div>
    <div class="doc-content">
        <h1 id="integration-with-wai-middleware">Integration with WAI middleware</h1>

<p>Although you usually run a <code class="highlighter-rouge">mu-rpc</code> server directly using a function like <code class="highlighter-rouge">runGRpcApp</code>, this is just a convenience function to make it simpler to run the server. Under the hood, the library generates a so-called WAI application, which is then fed to an actual server.</p>

<p>WAI stands for <a href="https://www.yesodweb.com/book/web-application-interface"><em>Web Application Interface</em></a>. WAI defines a common set of APIs against which web application can be developed. Web servers, like <a href="http://www.aosabook.org/en/posa/warp.html">Warp</a>, take an application which uses that API and serves it against the actual network. The main benefit of this separation is that applications and servers can evolve separately, without a tight coupling between them.</p>

<p>One of the features that WAI provides is the definition of <em>middleware</em> components. <em>Middlewares</em> are not complete applications; instead they wrap another application to provide additional capabilities. There is a whole ecosystem of WAI middleware, as one can notice by <a href="http://hackage.haskell.org/packages/search?terms=wai+middleware">searching <code class="highlighter-rouge">wai middleware</code> in Hackage</a>.</p>

<h2 id="serving-static-files">Serving static files</h2>

<p>It’s a common task in web servers to send some static content for a subset of URLs (think of resources such as images or JavaScript code). <code class="highlighter-rouge">wai-middleware-static</code> automates that task, and also serves as the simplest example of WAI middleware.</p>

<p>Remember that in our <a href="/mu-haskell/wip/grpc/server/">gRPC server example</a> our <code class="highlighter-rouge">main</code> function looked as follows:</p>

<div class="language-haskell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">main</span> <span class="o">=</span> <span class="n">runGRpcApp</span> <span class="n">msgSerializer</span> <span class="mi">8080</span> <span class="n">server</span>
</code></pre></div></div>

<p>We can split this single line into two phases: first creating the WAI application by means of <code class="highlighter-rouge">gRpcApp</code>, and then running it using Warp’s <code class="highlighter-rouge">run</code> function.</p>

<div class="language-haskell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kr">import</span> <span class="nn">Network.Wai.Handler.Warp</span> <span class="p">(</span><span class="nf">run</span><span class="p">)</span>

<span class="n">main</span> <span class="o">=</span> <span class="n">run</span> <span class="mi">8080</span> <span class="o">$</span> <span class="n">gRpcApp</span> <span class="n">msgSerializer</span> <span class="n">server</span>
</code></pre></div></div>

<p>Right in the middle of the two steps we can inject any middleware we want.</p>

<div class="language-haskell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kr">import</span> <span class="nn">Network.Wai.Handler.Warp</span> <span class="p">(</span><span class="nf">run</span><span class="p">)</span>
<span class="kr">import</span> <span class="nn">Network.Wai.Middleware.Static</span>

<span class="n">main</span> <span class="o">=</span> <span class="n">run</span> <span class="mi">8080</span> <span class="o">$</span> <span class="n">static</span> <span class="p">(</span><span class="n">gRpcApp</span> <span class="n">msgSerializer</span> <span class="n">server</span><span class="p">)</span>
</code></pre></div></div>

<p>With that simple change, our web server now first checks whether a file with the requested name exists in the directory from which the application is running. If that is the case, it’s cached and served, otherwise the underlying gRPC application is run. Needless to say, this behavior might not be the desired one, so the library provides <a href="http://hackage.haskell.org/package/wai-middleware-static/docs/Network-Wai-Middleware-Static.html#v:staticPolicy"><code class="highlighter-rouge">staticPolicy</code></a> to customize it.</p>

<h2 id="metrics">Metrics</h2>

<p>Another interesting use of middleware is obtaining metrics for your application. Within the Haskell world, <a href="https://github.com/tibbe/ekg">EKG</a> is a common solution for monitoring any kind of running process. EKG provides <a href="https://ocharles.org.uk/blog/posts/2012-12-11-24-day-of-hackage-ekg.html">customizable counters</a>, so you are not tied to one specific set of variables. This is the idea behind the <a href="https://github.com/Helkafen/wai-middleware-metrics"><code class="highlighter-rouge">wai-middleware-metrics</code></a> package: provide counters for the specific needs of HTTP servers.</p>

<div class="language-haskell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kr">import</span> <span class="nn">System.Remote.Monitoring</span> <span class="p">(</span><span class="nf">serverMetricStore</span><span class="p">,</span> <span class="nf">forkServer</span><span class="p">)</span>
<span class="kr">import</span> <span class="nn">Network.Wai.Handler.Warp</span> <span class="p">(</span><span class="nf">run</span><span class="p">)</span>
<span class="kr">import</span> <span class="nn">Network.Wai.Metrics</span>

<span class="n">main</span> <span class="o">=</span> <span class="kr">do</span>
  <span class="c1">-- Taken from the official documentation</span>
  <span class="n">store</span> <span class="o">&lt;-</span> <span class="n">serverMetricStore</span> <span class="o">&lt;$&gt;</span> <span class="n">forkServer</span> <span class="s">"localhost"</span> <span class="mi">8000</span>
  <span class="n">waiMetrics</span> <span class="o">&lt;-</span> <span class="n">registerWaiMetrics</span> <span class="n">store</span>
  <span class="c1">-- Wrap the application and run it</span>
  <span class="n">run</span> <span class="mi">8080</span> <span class="o">$</span> <span class="n">metrics</span> <span class="n">waiMetrics</span> <span class="p">(</span><span class="n">gRpcApp</span> <span class="n">msgSerializer</span> <span class="n">server</span><span class="p">)</span>
</code></pre></div></div>

<p>Another possibility is to expose <a href="https://prometheus.io/">Prometheus</a> metrics. In this case, a specific monitoring process scrapes your servers from time to time. The gathered data can later be analyzed and visualized. Luckily, there’s some <a href="https://github.com/fimad/prometheus-haskell">middleware</a> exposing the require endpoints automatically.</p>

<div class="language-haskell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kr">import</span> <span class="nn">Network.Wai.Handler.Warp</span> <span class="p">(</span><span class="nf">run</span><span class="p">)</span>
<span class="kr">import</span> <span class="nn">Network.Wai.Middleware.Prometheus</span>

<span class="n">main</span> <span class="o">=</span> <span class="n">run</span> <span class="mi">8080</span> <span class="o">$</span> <span class="n">prometheus</span> <span class="n">def</span> <span class="p">(</span><span class="n">gRpcApp</span> <span class="n">msgSerializer</span> <span class="n">server</span><span class="p">)</span>
</code></pre></div></div>

<p>The usage of <code class="highlighter-rouge">def</code> indicates that we want the default options: providing the metrics under the route <code class="highlighter-rouge">/metrics</code>.</p>

<h2 id="compression-header-manipulation-and-more">Compression, header manipulation, and more!</h2>

<p>These docs only scrape the surface of WAI middleware. We encourage you to check the <a href="http://hackage.haskell.org/package/wai-extra"><code class="highlighter-rouge">wai-extra</code> package</a>, which includes many self-contained middlewares. For example, you may wish to have GZip compression, or to canonicalize routes before passing them to the actual application. Following the Haskell philosophy, the idea is to provide small components which can be easily composed to target your needs.</p>

    </div>
</main>

    </body>
</html>
